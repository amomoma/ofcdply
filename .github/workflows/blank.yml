name: Download Microsoft Office (Single 7z)

on:
  workflow_dispatch:
    inputs:
      config_url:
        description: 'URL to your configuration.xml'
        required: true

jobs:
  download:
    runs-on: windows-latest
    timeout-minutes: 180

    steps:
      # 1️⃣ Prepare workspace
      - name: Prepare workspace
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path C:\OfficeSetup

      # 2️⃣ Install 7-Zip
      - name: Install 7-Zip
        shell: powershell
        run: |
          choco install 7zip -y

      # 3️⃣ Download Office Deployment Tool
      - name: Download Office Deployment Tool
        shell: powershell
        run: |
          cd C:\OfficeSetup
          Invoke-WebRequest -Uri "https://officecdn.microsoft.com/pr/wsus/setup.exe" -OutFile setup.exe

      # 4️⃣ Download your configuration.xml
      - name: Download Configuration.xml
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "${{ github.event.inputs.config_url }}" -OutFile "C:\OfficeSetup\configuration.xml"

      # 5️⃣ Download Office files only
      - name: Download Office files
        shell: powershell
        run: |
          cd C:\OfficeSetup
          .\setup.exe /download configuration.xml

      # 6️⃣ Compress entire folder into one 7z archive
      - name: Compress Office folder (7-Zip)
        shell: powershell
        run: |
          $source = "C:\OfficeSetup\*"
          $output = "C:\OfficeSetup.7z"
          & "C:\Program Files\7-Zip\7z.exe" a -t7z "$output" "$source"

      # 7️⃣ Upload the 7z archive as artifact
      - name: Upload Office archive
        uses: actions/upload-artifact@v4
        with:
          name: Office365-Offline
          path: C:\OfficeSetup.7z
          retention-days: 90
