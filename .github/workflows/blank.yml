name: Download Microsoft Office (Single 7z)

on:
  workflow_dispatch:

jobs:
  download:
    runs-on: windows-latest
    timeout-minutes: 180

    steps:
      # 1️⃣ Prepare workspace
      - name: Prepare workspace
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path C:\OfficeSetup

      # 2️⃣ Install 7-Zip
      - name: Install 7-Zip
        shell: powershell
        run: |
          choco install 7zip -y

      # 3️⃣ Download Office Deployment Tool
      - name: Download Office Deployment Tool
        shell: powershell
        run: |
          cd C:\OfficeSetup
          Invoke-WebRequest -Uri "https://officecdn.microsoft.com/pr/wsus/setup.exe" -OutFile setup.exe

      # 4️⃣ Create configuration.xml
      - name: Create configuration.xml
        shell: powershell
        run: |
          @"
          <Configuration ID="51fab5ac-8cdf-4399-bb5f-bbda954e5497">
            <Add OfficeClientEdition="64" Channel="CurrentPreview" Version="16.0.19725.20078">
              <Product ID="O365ProPlusRetail">
                <Language ID="en-us" />
                <ExcludeApp ID="Access" />
                <ExcludeApp ID="Groove" />
                <ExcludeApp ID="Lync" />
                <ExcludeApp ID="M365Companion" />
                <ExcludeApp ID="OneDrive" />
                <ExcludeApp ID="OneNote" />
                <ExcludeApp ID="Outlook" />
                <ExcludeApp ID="OutlookForWindows" />
                <ExcludeApp ID="Publisher" />
                <ExcludeApp ID="Teams" />
              </Product>
            </Add>
            <Display Level="None" AcceptEULA="TRUE" />
          </Configuration>
          "@ | Out-File -Encoding ASCII C:\OfficeSetup\configuration.xml

      # 5️⃣ Download Office files only
      - name: Download Office files
        shell: powershell
        run: |
          cd C:\OfficeSetup
          .\setup.exe /download configuration.xml

      # 6️⃣ Compress entire folder into one 7z archive
      - name: Compress Office folder (7-Zip)
        shell: powershell
        run: |
          $source = "C:\OfficeSetup\*"
          $output = "C:\OfficeSetup.7z"
          & "C:\Program Files\7-Zip\7z.exe" a -t7z "$output" "$source"

      # 7️⃣ Upload the 7z archive as artifact
      - name: Upload Office archive
        uses: actions/upload-artifact@v4
        with:
          name: Office365-Offline
          path: C:\OfficeSetup.7z
          retention-days: 90
